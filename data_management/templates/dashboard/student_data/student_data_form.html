{% extends 'base.html' %}
{% load static %}
{% load split_url %}

{% block title %}Edit Profil Mahasiswa - KMM Mesir{% endblock %}

{% block navbar %}{% include 'navbar.html' %}{% endblock %}
{% block sidebar %}{% include 'sidebar.html' %}{% endblock %}

{% block content %}
<div class="w-full p-6 space-y-6" x-data="{ submitting:false }">
  <div class="flex items-center justify-between flex-wrap gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">Edit Profil Mahasiswa</h1>
      <p class="text-sm text-gray-500">Perbarui data profil Anda.</p>
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'profile' %}" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium">‚Üê Kembali</a>
    </div>
  </div>

  <form id="student-profile-form" method="post" enctype="multipart/form-data" class="bg-white shadow rounded-lg p-6 space-y-8" x-on:submit="submitting=true">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="p-4 rounded border border-red-300 bg-red-50 text-sm text-red-700">
        {% for err in form.non_field_errors %}<p>{{ err }}</p>{% endfor %}
      </div>
    {% endif %}

    <!-- Foto Profil -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Foto Profil</h2>
      <div class="text-sm">
        {% with f=form|get_field:photo_field %}
        <div>
          <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
          {{ f }}
          {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
        </div>
        {% endwith %}
      </div>
    </div>

    <!-- Identitas Dasar -->
       <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Identitas Dasar</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        {% for field_name in basic_fields %}
          {% with f=form|get_field:field_name %}
          <div {% if field_name == 'region_origin' %}x-data="kabupatenSelect()"{% endif %}>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>

            {% if field_name == 'region_origin' %}
              <!-- Custom autocomplete for region_origin -->
              <div class="relative">
                <input
                  type="text"
                  name="{{ f.name }}"
                  name="{{ f.name }}"
                  x-model="query"
                  x-on:input="searchKabupaten()"
                  x-on:focus="show = !!filteredKabupaten.length"
                  x-on:blur="hideList()"
                  placeholder="Ketik nama kabupaten/kota..."
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring focus:border-blue-500 text-sm"
                  autocomplete="off"
                />

                <!-- Dropdown list -->
                <div
                  x-show="show && filteredKabupaten.length"
                  x-transition
                  class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"
                >
                  <template x-for="kab in filteredKabupaten" :key="kab">
                    <div
                      x-text="kab"
                      x-on:click="selectKabupaten(kab)"
                      class="px-3 py-2 cursor-pointer hover:bg-blue-50 border-b border-gray-100 last:border-b-0"
                    ></div>
                  </template>
                </div>
              </div>
            {% else %}
              {{ f }}
            {% endif %}

            {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Akademik -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Akademik</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        {% for field_name in academic_fields %}
          {% with f=form|get_field:field_name %}
          <div {% if field_name == 'institution' %}x-data="universitySelect()"{% endif %}>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>

            {% if field_name == 'institution' %}
              <!-- Custom autocomplete for institution -->
              <div class="relative">
                <input
                  type="text"
                  name="{{ f.name }}"
                  x-model="query"
                  x-on:input="searchUniversities()"
                  x-on:focus="show = !!filteredUniversities.length"
                  x-on:blur="hideList()"
                  placeholder="Ketik nama universitas..."
                  class="mt-1 w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-md focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary"
                  autocomplete="off"
                />

                <!-- Dropdown list -->
                <div
                  x-show="show && filteredUniversities.length"
                  x-transition
                  class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"
                >
                  <template x-for="uni in filteredUniversities" :key="uni">
                    <div
                      x-text="uni"
                      x-on:click="selectUniversity(uni)"
                      class="px-3 py-2 cursor-pointer hover:bg-blue-50 border-b border-gray-100 last:border-b-0 text-sm"
                    ></div>
                  </template>
                </div>
              </div>
            {% else %}
              {{ f }}
            {% endif %}

            {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Identitas Tambahan -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Identitas Tambahan</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        {% for field_name in identity_extra_fields %}
          {% with f=form|get_field:field_name %}
          <div>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
            {{ f }}
            {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Kesehatan -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Kesehatan</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        {% for field_name in health_fields %}
          {% with f=form|get_field:field_name %}
          <div>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
            {{ f }}
            {% if f and f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Minat & Prestasi -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Minat & Prestasi</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
        {% for pair in interest_field_pairs %}
          {% with f1=form|get_field:pair.0 f2=form|get_field:pair.1 %}
          <div class="space-y-2">
            <div>
              <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f1.label }}</label>
              {{ f1 }}
              {% if f1 and f1.errors %}<p class="text-xs text-red-600 mt-1">{{ f1.errors.0 }}</p>{% endif %}
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f2.label }}</label>
              {{ f2 }}
              {% if f2 and f2.errors %}<p class="text-xs text-red-600 mt-1">{{ f2.errors.0 }}</p>{% endif %}
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Informasi Keuangan -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Informasi Keuangan</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        {% for field_name in financial_fields %}
          {% with f=form|get_field:field_name %}
          <div>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
            {{ f }}
            {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Riwayat Organisasi -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Riwayat Organisasi</h2>
      <div>
        {% with f=form|get_field:organization_field %}
        <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
        {{ f }}
        {% if f and f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
        {% endwith %}
      </div>
    </div>

    <div class="flex flex-wrap justify-end gap-3 pt-4 border-t">
      <button type="submit" name="action" value="save_draft" class="px-5 py-2.5 rounded bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium" x-bind:disabled="submitting">Simpan Draft</button>
      <button type="submit" name="action" value="save" class="px-5 py-2.5 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium" x-bind:disabled="submitting">Simpan</button>
    </div>
  </form>
</div>

<script>
function kabupatenSelect() {
  return {
    kabupatenList: [],
    filteredKabupaten: [],
    query: '',
    show: false,
    isLoading: false,
    selectedValue: '',
    selectedIndex: 0,
    isValidSelection: true,
    fetchKabupaten() {
      this.isLoading = true;
      fetch('https://api-regional-indonesia.vercel.app/api/cities/8')
        .then(res => res.json())
        .then(data => {
          // Use the 'data' key from the API response
          this.kabupatenList = (data.data || []).map(k => k.name);
        })
        .catch(error => {
          console.error('Error fetching kabupaten data:', error);
        })
        .finally(() => {
          this.isLoading = false;
        });
    },
    searchKabupaten() {
      if (!this.kabupatenList.length) return;
      const q = this.query.toLowerCase();
      this.filteredKabupaten = this.kabupatenList.filter(kab => kab.toLowerCase().includes(q)).slice(0, 10);
      this.show = !!this.filteredKabupaten.length;
      this.isValidSelection = this.filteredKabupaten.includes(this.query);
    },
    selectKabupaten(kab) {
      this.query = kab;
      this.selectedValue = kab;
      this.show = false;
      this.isValidSelection = true;
    },
    clearAndHide() {
      this.query = '';
      this.show = false;
      this.isValidSelection = true;
    },
    selectFirstMatch() {
      if (this.filteredKabupaten.length === 1) {
        this.selectKabupaten(this.filteredKabupaten[0]);
      }
    },
    hideList() {
      setTimeout(() => { this.show = false; }, 100);
    },
    init() {
      this.fetchKabupaten();
      this.query = '{{ form.region_origin.value|default_if_none:"" }}';
    }
  }
}

function universitySelect() {
  return {
    universityList: [],
    filteredUniversities: [],
    query: '',
    show: false,
    isLoading: false,
    selectedValue: '',
    selectedIndex: 0,
    isValidSelection: true,
    fetchUniversities() {
      this.isLoading = true;
      fetch('http://universities.hipolabs.com/search?country=Egypt')
        .then(res => res.json())
        .then(data => {
          // Extract university names from the API response
          this.universityList = (data || []).map(uni => uni.name);
        })
        .catch(error => {
          console.error('Error fetching university data:', error);
          // Fallback to static list if API fails
          this.universityList = [
            'Arab Academy for Science & Technology',
            'Alexandria University',
            'American University in Cairo',
            'Cairo University',
            'Al Azhar University',
            'Ain Shams University',
            'German University in Cairo',
            'Helwan University',
            'Mansoura University',
            'Zagazig University'
          ];
        })
        .finally(() => {
          this.isLoading = false;
        });
    },
    searchUniversities() {
      if (!this.universityList.length) return;
      const q = this.query.toLowerCase();
      this.filteredUniversities = this.universityList.filter(uni => uni.toLowerCase().includes(q)).slice(0, 10);
      this.show = !!this.filteredUniversities.length;
      this.isValidSelection = this.filteredUniversities.includes(this.query);
    },
    selectUniversity(uni) {
      this.query = uni;
      this.selectedValue = uni;
      this.show = false;
      this.isValidSelection = true;
    },
    clearAndHide() {
      this.query = '';
      this.show = false;
      this.isValidSelection = true;
    },
    selectFirstMatch() {
      if (this.filteredUniversities.length === 1) {
        this.selectUniversity(this.filteredUniversities[0]);
      }
    },
    hideList() {
      setTimeout(() => { this.show = false; }, 100);
    },
    init() {
      this.fetchUniversities();
      this.query = '{{ form.institution.value|default_if_none:"" }}';
    }
  }
}

(function(){
  const form = document.getElementById('student-profile-form');
  if(!form) return;
  let dirty = false;
  form.addEventListener('change', () => { dirty = true; });
  window.addEventListener('beforeunload', function(e){
    if(dirty && !form.dataset.submitted){
      e.preventDefault();
      e.returnValue = '';
    }
  });
  form.addEventListener('submit', ()=>{ form.dataset.submitted = '1'; dirty = false; });
})();
</script>
{% endblock %}
