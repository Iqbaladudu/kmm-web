{% extends 'base.html' %}
{% load static split_url %}
{% block title %}Edit Mahasiswa - {{ student.full_name }}{% endblock %}

{% block navbar %}{% include 'navbar.html' %}{% endblock %}
{% block sidebar %}{% include 'sidebar.html' %}{% endblock %}

{% block content %}
<div class="w-full p-6 space-y-6" x-data="{ submitting:false }">
  <div class="flex items-center justify-between flex-wrap gap-4">
    <div class="flex items-center gap-3 flex-wrap">
      <h1 class="text-2xl font-bold text-gray-800">Edit Mahasiswa</h1>
      {% if student.is_draft %}<span class="px-2 py-0.5 text-xs rounded bg-amber-500 text-white font-semibold">Draft</span>{% endif %}
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'staff_student_detail' student.pk %}" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium">‚Üê Kembali</a>
    </div>
  </div>

  <form id="student-edit-form" method="post" enctype="multipart/form-data" class="bg-white shadow rounded-lg p-6 space-y-8" x-on:submit="submitting=true">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ next_url }}" />
    {{ form.is_draft }}

    {% if form.non_field_errors %}
      <div class="p-4 rounded border border-red-300 bg-red-50 text-sm text-red-700">
        {% for err in form.non_field_errors %}<p>{{ err }}</p>{% endfor %}
      </div>
    {% endif %}

    <!-- Identitas Dasar -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Identitas Dasar</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        {% for field_name in basic_fields %}
          {% with f=form|get_field:field_name %}
          <div>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
            {{ f }}
            {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Akademik -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Akademik</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        {% for field_name in academic_fields %}
          {% with f=form|get_field:field_name %}
          <div>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
            {{ f }}
            {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Identitas Tambahan -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Identitas Tambahan</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        {% for field_name in identity_extra_fields %}
          {% with f=form|get_field:field_name %}
          <div>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
            {{ f }}
            {% if f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Kesehatan -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Kesehatan</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        {% for field_name in health_fields %}
          {% with f=form|get_field:field_name %}
          <div>
            <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
            {{ f }}
            {% if f and f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Minat & Prestasi -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Minat & Prestasi</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
        {% for pair in interest_field_pairs %}
          {% with f1=form|get_field:pair.0 f2=form|get_field:pair.1 %}
          <div class="space-y-2">
            <div>
              <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f1.label }}</label>
              {{ f1 }}
              {% if f1 and f1.errors %}<p class="text-xs text-red-600 mt-1">{{ f1.errors.0 }}</p>{% endif %}
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f2.label }}</label>
              {{ f2 }}
              {% if f2 and f2.errors %}<p class="text-xs text-red-600 mt-1">{{ f2.errors.0 }}</p>{% endif %}
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Riwayat Organisasi -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-800">Riwayat Organisasi</h2>
      <div>
        {% with f=form|get_field:organization_field %}
        <label class="block text-gray-600 mb-1 text-xs font-medium">{{ f.label }}</label>
        {{ f }}
        {% if f and f.errors %}<p class="text-xs text-red-600 mt-1">{{ f.errors.0 }}</p>{% endif %}
        {% endwith %}
      </div>
    </div>

    <div class="flex flex-wrap justify-end gap-3 pt-4 border-t">
      <button type="submit" name="action" value="save_draft" class="px-5 py-2.5 rounded bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium" x-bind:disabled="submitting">Simpan Draft</button>
      <button type="submit" name="action" value="save_back" class="px-5 py-2.5 rounded bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium" x-bind:disabled="submitting">Simpan & Kembali</button>
      <button type="submit" name="action" value="save" class="px-5 py-2.5 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium" x-bind:disabled="submitting">Simpan</button>
    </div>
  </form>
</div>

<script>
(function(){
  const form = document.getElementById('student-edit-form');
  if(!form) return;
  const initial = new FormData(form);
  let dirty = false;
  form.addEventListener('change', () => { dirty = true; });
  window.addEventListener('beforeunload', function(e){
    if(dirty && !form.dataset.submitted){
      e.preventDefault();
      e.returnValue = '';
    }
  });
  form.addEventListener('submit', ()=>{ form.dataset.submitted = '1'; dirty = false; });
})();
</script>
{% endblock %}
